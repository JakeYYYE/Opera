# 更新日志 (Changelog)

## [未发布] - 2026-01-15

### 新增 (Added)
- **注册流程优化**: 
  - 注册弹窗新增身份意图选择（"我是需求方" / "我是服务方"），注册时即捕获用户初始意图并自动配置对应初始等级（服务方意图预设为 Lv1）。
- **C端升级审核增强**:
  - C端用户管理页（`AdminUserCManage.vue`）新增升级申请详情查看功能。管理员可点击“详情”查看企业信息及申请材料（飞手证、保险），并在弹窗内直接进行审核（通过/驳回）。

### 变更 (Changed)
- **后台菜单优化**: 侧边栏“C端用户”重命名为“C端用户管理”，保持菜单命名一致性。
- **身份标签简化**: 
  - C端用户管理与B端用户管理列表中的身份标签统一简化为“需求方”与“服务方”，移除“个人需求方/企业需求方/认证飞手”等冗余标签，提升列表可读性。
- 身份与接单权限：调整需求详情页的“投递方案 / 立即接单”入口逻辑，统一按照账号角色判断：
  - C 端认证用户（个人实名认证 + 飞手认证，`role = c-user && certificationStatus = approved`）可以接单；
  - B 端服务商用户（`role = b-user`）可以接 B 端项目订单，也可以接当前开放给 C 端的订单；
  - 其他用户点击接单时，将收到“当前账号暂不支持接单，请完成认证或升级为服务商”的提示。
- 企业身份识别：需求详情页顶部“企业用户”标识从基于 `providerLevel` 推断，改为直接以 `role = b-user` 判断，使文案与账号模型一致。

## [未发布] - 2026-01-14

### 新增 (Added)
- 新闻模块：新增 `src/views/NewsList.vue` 与 `src/views/NewsDetail.vue`，接入统一数据源 `useMockData.js`。
- 路由：新增 `/news` 与 `/news/:id`，首页「查看更多」与新闻卡片点击联动。
- 数据：扩充 `news` 数据至 12 条，采用 HTML 段落排版。
- 飞行地图（FindSpot）：
  - 右侧垂直工具栏：创建航拍点、测距、测面积。
  - 测距交互：支持右键或双击结束、段距中点标签、清点按钮移入测距面板。
  - 测面积交互：多边形点选、面积计算显示、撤销/完成/清面。
  - 标签弹层：点击“航拍点”标签弹出内容浮层（推荐航拍点与我的航拍点），遮罩点击关闭。
  - 航拍点缩略图：公共推荐点与用户航拍点在地图上以圆形首图缩略图作为 Marker 图标，点击 Marker 或列表卡片时通过当前页弹窗展示详情。
 - 移动端适配与交互优化：
   - 消息中心（`Messages.vue`）：
     - 桌面端保持左右双栏（列表 + 会话），移动端改为“消息列表视图 / 会话详情视图”的双视图模式，并在详情页顶部提供“返回列表”入口。
     - 聊天气泡与报价方案卡片在移动端缩小边距与字号，避免一屏只显示少量内容；底部输入区增加安全区适配，避免被系统手势栏遮挡。
     - 消息列表支持未读红点标记（基于 `msg.unread` 字段）。
   - 我的任务（`ProviderTasks.vue`）：
     - 保留桌面端表格视图；在移动端将任务折叠为卡片列表，展示任务标题、需求方、成交价、截止日期与状态。
     - 根据任务状态分支操作：状态为“已通过”时提供“提交成果 + 联系对方”按钮，其他状态提供“查看详情 + 联系对方”按钮。
   - 我的需求（`RequesterNeeds.vue`）：
     - 桌面端仍为表格视图；移动端改为需求卡片，顶部为标题 + 状态，中间为类型标签与预算，底部为发布时间与“查看详情 / 撤销”操作。
     - 顶部“发布需求”入口在移动端为圆形图标按钮，桌面端为带文案的大按钮。
   - 我的服务能力（`ProviderServices.vue`）：
     - 桌面端延续原有卡片布局；移动端中，卡片底部的“编辑 / 上架/下架”操作默认可见，无需依赖 hover。
     - 顶部“发布新服务”入口在移动端收缩为圆形图标按钮，减少横向空间占用。
   - 首页推荐管理（`AdminNewsFeatured.vue`）：
     - 推荐位预览卡片在移动端保留核心信息展示，并将“更换内容”入口调整为卡片右下角的圆形编辑按钮。
     - 选择弹窗在移动端改为更窄的宽度（约 95% 视口宽度），并将原表格选择视图替换为垂直滚动的新闻卡片列表，点击整卡即可选择推荐内容。

### 变更 (Changed)
- 首页新闻板块改为按 `publishTime` 倒序展示最新 3 条。
- 资讯列表支持分类筛选与时间倒序；热门推荐按阅读量 Top5。
- `NewsDetail.vue` 采用 `v-html` 渲染富文本内容。
- 飞行地图推荐展示：列表改为缩略图网格（3列），标题遮罩与悬停放大。
- 标签样式：侧栏手柄改为独立“航拍点”标签，采用上下箭头作为状态提示。
- 交互优化（FindSpot）：创建航拍点模式下，支持**右键点击**取消创建状态并恢复默认地图交互。
 - Marker 交互：飞行地图上的推荐点与用户航拍点点击后不再跳转路由，而是在当前页面内打开详情弹窗，保持地图上下文连续。
 - 登录/注册 UI：Navbar 右侧“登录 / 注册”入口与登录弹窗主按钮统一为渐变圆角按钮样式，符合整体品牌视觉。
 - 注册角色选择 UI：注册弹窗中的“我要发需求 / 我是服务商”改为卡片式选择，展示简要说明并与身份中心逻辑打通。

### 修复 (Fixed)
- 修复 `useMockData.js` 导入解析错误（`news` 嵌入 `providers`）；补充本地存储迁移逻辑，确保字段一致性。
- 飞行地图弹层评论渲染：为“我的航拍点”补齐默认属性并增加模板兜底，修复 `comments.length` 读取异常。

## [未发布] - 2026-01-13

### 新增 (Added)
- **身份切换体系**:
  - `src/composables/useAuth.js`: 新增 `switchIdentity` 方法，支持在拥有多重身份的用户间切换，并处理未注册身份的申请流程。
  - `src/views/Home.vue`: 顶部导航栏新增身份状态展示与切换入口，采用智能弹窗逻辑区分“直接切换”与“申请表单”。
- **C端与小B端管理体系**:
  - 新增 `src/views/AdminUserCManage.vue`: C端用户管理，核心包含**飞手认证审核**功能，支持从C端向B端转化的业务逻辑。
  - 新增 `src/views/AdminUserSmallBManage.vue`: 小B端商户管理，支持航拍公司与保险机构的分类管理。
  - 新增 `src/data/mockUsers.js`: 定义了 Novice (小白), Advanced (进阶), Small B (商户) 三类用户的模拟数据结构。
- **后台布局结构**: 将后台侧边栏导航按逻辑进行了分组：
  - **总览**: 后台总览 (Dashboard)。
  - **业务管理**: 需求管理、服务商管理。
  - **内容管理**: 新闻管理、首页推荐。

### 调整 (Changed)
- **身份切换约束规则**:
  - 基于产品决策，补充“同端内切换”约束：B 端企业账号仅允许在「企业服务方 ↔ 企业需求方」之间切换，C 端个人账号仅允许在「个人服务方 ↔ 个人需求方」之间切换，不再支持跨端（B ↔ C）转换。
  - `src/composables/useAuth.js`: 更新 `switchIdentity` 实现，增加对账号端类型（b-user/c-user）与可用身份能力的校验，非法目标身份将返回错误提示“当前账号不支持切换到该身份”。
  - `src/components/Navbar.vue`: 根据账号端与当前身份，展示更精确的身份标签文案（如“企业服务方”“个人需求方”），并调整切换按钮文案为“切换为企业/个人服务方/需求方”。
  - `src/views/AdminLayout.vue`: 后台右上角头像区域统一接入同端内切换逻辑，与前台保持一致。
- **首页推荐管理**: 新增 `src/views/AdminNewsFeatured.vue` 模块：
  - 支持可视化管理首页的3个头部新闻推荐位。
  - 提供实时预览功能，所见即所得。
  - 支持从现有的新闻库中筛选并选择新闻。
  - 使用 `localStorage` 进行配置持久化，并与前台首页 (`Home.vue`) 实时联动。
- **服务商管理字段**: 新增了与前台展示对齐的字段：
  - `isVerified` (官方认证)
  - `rating` (服务评分)
  - `deals` (成交量)
  - `contactPerson` & `phone` (联系人信息)
  - `location` (服务区域)
- **新闻管理字段**: 新增了与前台展示对齐的字段：
  - `publishTime` (发布时间，支持通过日期选择器编辑)
  - `category` (与前台标签对齐：包含 "新品发布", "用户故事", "作业案例" 等)
  - `cover` (封面图片 URL)
  - `author` (来源/作者)
- **后台总览 (Dashboard)**:
  - **模块拆分**: 将总览页面拆分为“平台运营”和“新闻运营”两个独立标签页 (Tab)。
  - **新闻运营总览**: 新增了新闻运营专属视图，包含：
    - 4个核心指标卡片：内容总数、待审核内容、今日发布、转化率。
    - 2个 ECharts 可视化图表：内容发布趋势 (折线图) 和 内容分类占比 (饼图)。
    - 增强版待办任务列表 (支持优先级和截止日期)。
    - 热门内容排行组件。

### 变更 (Changed)
- **品牌升级 (Rebranding)**:
  - 全局替换 "服务平台" 为 "**智慧飞滴**" (Smart Fly Drop)。
  - 全局替换 "去哪拍" 为 "**飞行地图**" (Flight Map)。
  - 涉及文件: `src/views/Home.vue`, `src/views/AdminLayout.vue`, `src/components/LoginModal.vue` 及 PRD 文档。
- **文档架构**:
  - 重命名 `DOC/去哪拍PRD.md` 为 `DOC/飞行地图PRD.md`。
  - 更新 `DOC/PRD.md` 以反映最新的品牌名称与模块关系。
- **后台导航 (`src/views/AdminLayout.vue`)**: 
  - 重构 `el-menu` 使用 `el-sub-menu` 进行分组。
  - 更新图标以增强视觉区分度。
- **后台总览 (`src/views/AdminDashboard.vue`)**:
  - 引入 `el-tabs` 实现多视图切换，分离平台基础数据与新闻运营数据。
  - 优化了图表初始化逻辑，支持在 Tab 切换时动态渲染。
- **需求管理 (`src/views/AdminNeedsManage.vue`)**: 
  - 更新表单以包含所有前台可见字段 (预算、截止日期、交付物、联系信息)。
  - 实现了文本域 (Textarea) 输入自动解析为数组的功能 (针对需求列表、交付物列表)。
  - 标准化模拟数据，使其与前台 "需求大厅" 示例一致。
- **服务商管理 (`src/views/AdminProvidersManage.vue`)**:
  - 更新表格和表单布局为栅格布局 (Grid)，提高空间利用率。
  - 同步模拟数据与前台 "服务商库" 一致。
  - 在表格视图中增加了 "官方认证" 徽章和评分星级显示。
- **新闻管理 (`src/views/AdminNewsManage.vue`)**:
  - 更新分类选项以匹配首页新闻标签。
  - 启用 "发布时间" 编辑功能，允许补录或定时发布新闻。
  - 标准化模拟数据与首页新闻条目一致。
  - **数据架构**: 引入 `src/data/mockNews.js` 作为统一的新闻数据源，确保新闻管理、首页推荐和前台展示的数据一致性。
- **首页 (`src/views/Home.vue`)**:
  - 接入动态数据源，优先读取后台配置的推荐新闻，无配置时回退到默认数据。
- **文档 (Documentation)**:
  - 更新 `doc/PRD.md` 以同步最新的功能变更（后台 Dashboard 拆分、新增字段、数据模型更新）。

### 修复 (Fixed)
- **数据一致性**: 解决了后台管理表单与前台展示组件 (`Home.vue`, `ServiceNeeds.vue`, `ServiceProviders.vue`) 之间的字段差异，确保“所见即所得”的管理能力。
